within {{project_name}}.Loads.{{model_name}};
model coupling
  "FMU Template for Spawn"
 extends Modelica.Icons.Example;

   package MediumW = Buildings.Media.Water
   "Source side medium";
   package MediumA = Buildings.Media.Air
   "Load side medium";
{% raw %}
  // Do not fully qualify the path to building as {{project_name}}.Loads... That does
  // not work in JModelica.

 parameter Modelica.SIunits.MassFlowRate m1_flow_nominal = 15
   "Nominal mass flow rate of primary (district) district cooling side";
 parameter Modelica.SIunits.MassFlowRate m2_flow_nominal = 35
   "Nominal mass flow rate of secondary (building) district cooling side";

 CoolingIndirect coo(
    redeclare package Medium = MediumW,
     m1_flow_nominal=m1_flow_nominal,
     m2_flow_nominal=m2_flow_nominal,
     dp1_nominal=500,
     dp2_nominal=500,
     dpValve_nominal=7000,
     use_Q_flow_nominal=false,
     Q_flow_nominal=100000,
     T_a1_nominal=278.15,
     T_a2_nominal=289.15,
     eta=0.5)
     annotation (Placement(transformation(extent={{2,-82},{22,-62}})));
   building2 bui(
     have_weaBus=true,
     idfPat="modelica://Buildings/Resources/Data/ThermalZones/EnergyPlus/Validation/RefBldgSmallOfficeNew2004_Chicago.idf",
     weaPat="modelica://Buildings/Resources/weatherdata/USA_IL_Chicago-OHare.Intl.AP.725300_TMY3.mos",
     nPorts_a=2,
     nPorts_b=2) "Building model integrating multiple spawn thermal zones."
     annotation (Placement(transformation(extent={{0,58},{10,68}})));

   Fluid.Sources.MassFlowSource_T supChiWat(
     redeclare package Medium = MediumW,
     m_flow=15,
     use_T_in=false,
     T=278.15,
     nPorts=1) "Chilled water supply" annotation (Placement(transformation(
         extent={{-10,-10},{10,10}},
         rotation=0,
         origin={-30,-30})));
   Fluid.Sources.Boundary_pT sinChiWat(
     redeclare package Medium = MediumW,
     p=800000,
     T=287.15,
     nPorts=1)
    "Sink for chilled water"
      annotation (Placement(transformation(
         extent={{10,-10},{-10,10}},
         rotation=0,
         origin={50,-10})));
   Modelica.Blocks.Sources.RealExpression TChiWatSet(
      y=7 + 273.15)
     "Primary loop chilled water setpoint temperature"
     annotation (Placement(transformation(extent={{-60,-60},{-40,-40}})));

   Modelica.Blocks.Sources.RealExpression THeaWatSup(
      y=max(bui.terUni.T_aHeaWat_nominal))
     "Heating water supply temperature"
     annotation (Placement(transformation(extent={{-100,60},{-80,80}})));
   Fluid.Sources.MassFlowSource_T supHeaWat(
     redeclare package Medium = MediumW,
     m_flow=35,
     use_T_in=true,
     nPorts=1) "Heating water supply" annotation (Placement(transformation(
         extent={{-10,-10},{10,10}},
         rotation=0,
         origin={-50,70})));
   Fluid.Sources.Boundary_pT sinHeaWat(
     redeclare package Medium =MediumW,
     p=300000,
     nPorts=1)
      "Sink for heating water" annotation (Placement(transformation(
           extent={{10,-10},{-10,10}},
           rotation=0,
           origin={88,78})));
   Fluid.Movers.FlowControlled_m_flow pumBui(
     redeclare package Medium = MediumW,
     m_flow_nominal=35,
     inputType=Buildings.Fluid.Types.InputType.Constant,
     nominalValuesDefineDefaultPressureCurve=true,
     use_inputFilter=false,
     dp_nominal=6000)
     "Building-side (secondary) pump"
     annotation (Placement(transformation(extent={{-40,-94},{-60,-74}})));
  Modelica.Fluid.Sources.FixedBoundary pre(redeclare package Medium = MediumW,
     p=300000,
       nPorts=1)
     "Pressure source"
    annotation (Placement(transformation(
         extent={{10,-10},{-10,10}},
         rotation=0,
         origin={90,-90})));
  Modelica.Fluid.Sources.FixedBoundary pre1(
     redeclare package Medium = MediumW,
     p=830000,
     nPorts=1)
     "Pressure source"
    annotation (Placement(transformation(
         extent={{-10,-10},{10,10}},
         rotation=0,
         origin={-50,-10})))
{% endraw %}
equation
{% raw %}
connect(supChiWat.ports[1], coo.port_a1) annotation (Line(points={{-20,-30},{-14,
          -30},{-14,-66},{2,-66}},  color={0,127,255}));
  connect(coo.port_b1, sinChiWat.ports[1]) annotation (Line(points={{22,-66},{22,
          -10},{40,-10}},color={0,127,255}));
  connect(coo.TSet, TChiWatSet.y) annotation (Line(points={{0,-72},{-20,-72},{-20,
          -50},{-39,-50}},color={0,0,127}));
  connect(supHeaWat.T_in,THeaWatSup. y) annotation (Line(points={{-62,74},{-68,74},
          {-68,70},{-79,70}},color={0,0,127}));
  connect(supHeaWat.ports[1], bui.ports_a[1]) annotation (Line(points={{-40,70},
          {-12,70},{-12,53},{-10,53}}, color={0,127,255}));
  connect(sinHeaWat.ports[1], bui.ports_b[1]) annotation (Line(points={{78,78},{
          70,78},{70,53},{20,53}}, color={0,127,255}));
  connect(coo.port_a2, bui.ports_b[2]) annotation (Line(points={{22,-78},{70,-78},
          {70,55},{20,55}}, color={0,127,255}));
  connect(coo.port_b2, pumBui.port_a) annotation (Line(points={{2,-78},{-12,-78},
          {-12,-84},{-40,-84}}, color={0,127,255}));
  connect(pumBui.port_b, bui.ports_a[2]) annotation (Line(points={{-60,-84},{-70,
          -84},{-70,55},{-10,55}}, color={0,127,255}));
  connect(pre.ports[1], coo.port_b2)  annotation (Line(points={{80,-90},{2,-90},
          {2,-78}},color={0,127,255}));
  connect(pre1.ports[1], coo.port_a1) annotation (Line(points={{-40,-10},{2,-10},
          {2,-66}},color={0,127,255}));
{% endraw %}

  // TODO: determine how to handle the "lines"
{% raw %}
annotation (Icon(coordinateSystem(preserveAspectRatio=false),
                                   extent={{-100,-100},{100,100}}),
         Diagram(coordinateSystem(preserveAspectRatio=false),
                                   extent={{-100,-100},{100,100}}),
  __Dymola_Commands(file="modelica://Buildings/Resources/Scripts/Dymola/Applications/DHC/Loads/Examples/CouplingETS_SpawnBuilding.mos"
        "Simulate and plot"),
Documentation(info=
"<html>
<p>
This example illustrates the cobling between the ETS and spawn building model.
</p>
<p>
Simulation with Dymola requires minimum version 2020x and setting
<code>Hidden.AvoidDoubleComputation=true</code>, see
<a href=\"modelica://Buildings.ThermalZones.EnergyPlus.UsersGuide\">
Buildings.ThermalZones.EnergyPlus.UsersGuide</a>.
</p>
</html>",
revisions=
"<html>
<ul>
<li>
March 30, 2020, by Nicholas Long:<br/>
First implementation.
</li>
</ul>
</html>"));
{% endraw %}
end CouplingETS_SpawnBuilding;
